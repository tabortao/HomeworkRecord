# 时间管理打卡小程序 - 数据结构分析

## 1. 数据存储方式

项目采用浏览器的 **localStorage** 作为本地存储解决方案，不依赖传统的服务器数据库。所有数据以 JSON 格式序列化后存储在浏览器的本地存储中，按用户ID进行分组管理。

### 1.1 存储特点
- **本地存储**：数据仅保存在用户的浏览器中
- **按用户分组**：大部分数据以 `数据类型_用户ID` 的格式作为键名存储
- **持久化**：除非用户手动清除浏览器数据或应用清除数据，否则数据会一直存在
- **简单高效**：适合小型应用，无需额外的数据库服务

## 2. 主要数据对象

### 2.1 用户(User)

**存储键名**：`users` (全局共享)

**字段定义**：
- `id`：字符串，用户唯一标识符
- `name`：字符串，用户名
- `avatar`：字符串，用户头像（emoji表情）
- `grade`：字符串，用户年级
- `password`：字符串，用户密码（可选，未设置时为空）

**示例数据**：
```javascript
{
  id: 'default-user',
  name: '淘淘同学',
  avatar: '👨‍🎓',
  grade: '幼儿园大班',
  password: '' // 可选，未设置密码时为空
}
```

### 2.2 当前用户ID

**存储键名**：`currentUserId`

**功能**：记录当前登录用户的ID，用于确定应该加载哪个用户的数据

### 2.3 任务(Task)

**存储键名**：`timeManagementTasks_${currentUserId}` (按用户分组)

**字段定义**：
- `id`：数字，任务唯一标识符
- `name`：字符串，任务名称
- `subject`：字符串，学科分类
- `description`：字符串，任务描述
- `plannedDuration`：数字，计划时长（分钟）
- `actualDuration`：数字，实际时长（分钟）
- `status`：字符串，任务状态（'completed' 或 'pending'）
- `date`：字符串，任务日期（YYYY-MM-DD格式）
- `coins`：数字，完成任务获得的金币数（可选）

**示例数据**：
```javascript
{
  id: 1729432985678,
  name: '朗读课文3遍',
  subject: '语文',
  description: '朗读课文《秋天的雨》3遍，注意读音和语调',
  plannedDuration: 30,
  actualDuration: 25,
  status: 'completed',
  date: '2024-10-20',
  coins: 5
}
```

### 2.4 小心愿(Wish)

**存储键名**：`timeManagementWishes_${currentUserId}` (按用户分组)

**字段定义**：
- `id`：数字，心愿唯一标识符
- `name`：字符串，心愿名称
- `content`：字符串，心愿描述
- `icon`：字符串，图标路径（如果是图片）
- `iconType`：字符串，图标类型（'emoji' 或图片路径）
- `iconEmoji`：字符串，emoji图标（如果使用emoji）
- `cost`：数字，兑换所需金币数
- `status`：字符串，状态（'available' 或其他状态）

**示例数据**：
```javascript
{
  id: 1729432985679,
  name: '看电视',
  content: '完成学习任务后可以看10分钟动画片',
  icon: '',
  iconType: 'emoji',
  iconEmoji: '📺',
  cost: 1,
  status: 'available'
}
```

### 2.5 学科颜色配置

**存储键名**：`subjectColors_${currentUserId}` (按用户分组)

**功能**：存储不同学科对应的显示颜色，用于UI展示

**示例数据**：
```javascript
{
  '语文': '#FF6B6B',
  '数学': '#4ECDC4', 
  '英语': '#45B7D1',
  '科学': '#96CEB4',
  '美术': '#FFD166',
  '音乐': '#F9C80E'
}
```

### 2.6 操作记录(ActivityLog)

**存储键名**：`activityLogs_${currentUserId}` (按用户分组)

**字段定义**：
- `id`：字符串，记录唯一标识符（时间戳）
- `timestamp`：字符串，操作时间（ISO格式）
- `user`：字符串，操作用户名
- `actionType`：字符串，操作类型
- `description`：字符串，操作描述

**操作类型枚举**：
- `task_add`/`task_delete`/`task_update`/`task_complete`：任务相关操作
- `subject_add`/`subject_delete`/`subject_update`：学科相关操作
- `wish_add`/`wish_delete`/`wish_update`/`wish_redeem`：心愿相关操作
- `user_add`/`user_delete`/`user_update`：用户相关操作
- `pomodoro_start`：番茄钟开始
- `data_clear`：数据清除

**示例数据**：
```javascript
{
  id: '1729432985678',
  timestamp: '2024-10-20T10:30:15.123Z',
  user: '淘淘同学',
  actionType: 'task_complete',
  description: '完成任务：朗读课文3遍'
}
```

## 3. 数据关系

### 3.1 主要关系图

```
User (用户)
  |
  +-- 1:N Task (任务)
  |
  +-- 1:N Wish (小心愿)
  |
  +-- 1:N ActivityLog (操作记录)
  |
  +-- 1:1 SubjectColors (学科颜色配置)
```

### 3.2 数据访问模式

- 所有用户共享 `users` 和 `currentUserId` 数据
- 每个用户拥有独立的任务、心愿、操作记录和学科颜色配置
- 数据加载时，首先获取当前用户ID，然后加载该用户的所有相关数据

## 4. 数据存储与加载机制

### 4.1 数据加载流程

1. 应用初始化时调用 `loadData()` 函数
2. 加载全局用户列表和当前用户ID
3. 根据当前用户ID加载该用户的特定数据：
   - 任务数据
   - 小心愿数据
   - 学科颜色配置
   - 操作记录
4. 如果用户是首次使用或数据不存在，创建默认数据

### 4.2 数据保存流程

1. 数据变更后通过专用的保存函数保存：
   - `saveData()`：保存任务、学科颜色和操作记录
   - `saveWishes()`：保存心愿数据
   - `saveUsers()`：保存用户数据
2. 保存操作会将数据序列化为JSON并存储到localStorage

### 4.3 数据清理机制

- 操作记录有30天的保留期限（`MAX_LOG_AGE_DAYS = 30`）
- 每次添加新记录或加载数据时，会调用 `cleanOldLogs()` 清理过期记录

## 5. 模拟数据生成

项目包含 `mockData.js` 模块，用于生成测试数据：

- 定义了固定的学科列表（语文、数学、英语、科学、美术、音乐）
- 为每个学科提供了任务模板和描述模板
- `generateMockTasks()` 函数可生成过去7天的模拟任务数据
- 模拟数据包含随机的学科、任务名称、描述、时长和完成状态

## 6. 数据安全性

- 用户密码以明文形式存储在localStorage中（安全风险）
- 不同用户的数据通过用户ID分隔，实现简单的隔离
- 操作记录保留用户活动历史，便于追踪和审计

## 7. 数据库优化建议

1. **密码安全**：用户密码应加密存储，而不是明文
2. **数据验证**：增加数据完整性和有效性验证
3. **索引优化**：对于频繁查询的字段，可考虑添加内存索引
4. **数据压缩**：对于大量数据，可考虑使用压缩算法减少存储占用
5. **备份机制**：增加数据导出/导入功能，防止浏览器数据丢失
6. **数据迁移**：为未来可能的数据结构变更预留迁移机制